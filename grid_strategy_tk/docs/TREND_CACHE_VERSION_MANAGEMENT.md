# 趋势缓存版本管理说明

## 概述

当修改趋势判断算法参数时（如从4连涨改为3连涨），系统需要能够识别缓存是否无效并自动重置。本系统通过文件级别的版本号机制来解决这个问题。

## 使用方法

### 1. 修改算法参数后更新版本号

当您修改了趋势判断算法的参数时，需要更新 `version` 变量：

```python
# 在 watchlist_window.py 第107行
self.version = "v1.0.0"  # 当前算法版本号
```

**版本号命名建议：**
- 主版本号：重大算法变更（如改变连涨天数要求）
- 次版本号：算法优化或参数调整
- 修订号：bug修复

**示例：**
- `v1.0.0` - 初始版本
- `v1.1.0` - 从4连涨改为3连涨
- `v1.1.1` - 修复3连涨算法中的bug
- `v2.0.0` - 完全重写趋势判断逻辑

### 2. 自动缓存清理

系统启动时会自动：
1. 检查所有缓存数据的版本号
2. 清除版本号不匹配的旧缓存
3. 在控制台输出清理信息

### 3. 缓存验证机制

每次使用缓存数据时，系统会验证：
- 算法版本号是否匹配
- 缓存时间是否超时（24小时）
- 缓存数据是否包含错误

## 技术实现

### 缓存数据结构

```json
{
  "version": "v1.0.0",
  "data": {
    "000001": {
      "timestamp": 1703123456.789,
      "data": {
        "day_trend": "+2.5%",
        "week_trend": "+5.8%",
        "month_trend": "+12.3%"
      }
    }
  }
}
```

### 关键方法

1. **`is_trend_cache_valid(symbol)`** - 检查缓存是否有效
2. **`clear_old_version_cache()`** - 清除旧版本缓存
3. **`save_trend_data(symbol, ...)`** - 保存趋势数据到文件级别版本控制的缓存

## 注意事项

1. **版本号更新后重启应用**：修改版本号后需要重启应用才能生效
2. **备份重要数据**：清除缓存前建议备份重要的趋势分析结果
3. **性能影响**：首次运行新版本时会重新计算所有趋势数据，可能需要较长时间
4. **版本号格式**：建议使用语义化版本号格式（如 v1.0.0）

## 故障排除

### 问题：修改参数后仍使用旧结果
**解决方案：** 确保已更新 `version` 并重启应用

### 问题：缓存清理失败
**解决方案：** 检查 `grid_strategy_tk/config/trend_cache.json` 文件权限

### 问题：版本号不匹配警告过多
**解决方案：** 确认版本号格式正确，避免频繁修改版本号

## 示例场景

### 场景1：从4连涨改为3连涨

1. 修改趋势判断逻辑（将连涨要求从4改为3）
2. 更新版本号：`self.version = "v1.1.0"`
3. 重启应用
4. 系统自动清除所有旧版本缓存
5. 重新计算趋势数据

### 场景2：优化算法性能

1. 优化算法实现但保持参数不变
2. 更新版本号：`self.version = "v1.0.1"`
3. 重启应用
4. 系统会重新计算所有数据以使用优化后的算法

## 新格式优势

### 1. 简化管理
- **文件级别版本控制**：只需维护一个版本号，而不是每个记录一个
- **统一版本检查**：只需比较一次版本号，提高性能
- **减少存储开销**：避免在每个记录中重复存储版本号

### 2. 数据结构优化
- **清晰层次**：`version` → `data` → `symbol` → `{timestamp, data}`
- **易于维护**：版本更新时只需修改文件根级别的版本号
- **向后兼容**：自动检测并转换旧格式缓存

### 3. 性能提升
- **快速版本检查**：O(1) 时间复杂度检查版本匹配
- **批量清理**：版本不匹配时一次性清理所有数据
- **内存效率**：减少重复的版本号存储

## 统一配置管理

### 趋势判断参数配置

系统现在使用统一的配置管理各周期的连阳天数要求：

```python
# 在 src/trend_config.py 中
DAILY_MIN_CONSECUTIVE_DAYS = 4    # 日级：4个连续上涨交易日
WEEKLY_MIN_CONSECUTIVE_DAYS = 4   # 周级：4个连续上涨周
MONTHLY_MIN_CONSECUTIVE_DAYS = 3  # 月级：3个连续上涨月
```

### 配置修改方法

1. **查看当前配置**：
   ```bash
   python config_trend_requirements.py
   ```

2. **修改配置**：
   编辑 `src/trend_config.py` 文件中的对应变量

3. **重启应用**：
   系统会自动检测版本变化并清除相关缓存

### 配置优势

- **集中管理**：所有趋势判断参数统一在 `trend_config.py` 中管理
- **独立控制**：日级、周级、月级可以独立设置不同的连阳天数要求
- **版本控制**：配置变更会自动触发缓存清理
- **易于维护**：修改参数无需在多个文件中查找和替换
