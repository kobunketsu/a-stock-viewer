# K线图异步加载功能说明

## 功能概述

为了提高K线图的加载速度，我们将资金来源图和成本涨幅图的信号点显示处理改为异步加载。这样用户可以在主图表加载完成后立即看到K线图，而资金来源数据和信号点会在后台异步加载。

## 主要优化点

### 1. 异步加载资金来源图
- **原来**: 在主线程中同步获取营业部详细数据，计算股数，绘制图表
- **现在**: 主图表加载完成后立即显示"加载中"，后台异步获取数据并更新图表

### 2. 异步加载成本涨幅图信号点
- **原来**: 在主线程中同步检查所有条件，绘制信号标记点
- **现在**: 主图表加载完成后立即显示"加载中"，后台异步检查条件并绘制信号点

### 3. 智能任务取消
- 当用户切换股票、刷新数据、切换周期或缩放时，自动取消之前的异步任务
- 避免资源浪费和过时数据的显示

## 技术实现

### 异步任务管理
```python
# 异步任务相关变量
self._async_fund_task: Optional[threading.Thread] = None  # 资金来源异步任务
self._async_cost_task: Optional[threading.Thread] = None  # 成本涨幅信号异步任务
self._async_cancelled: bool = False  # 异步任务取消标志
```

### 加载状态显示
```python
def _show_fund_loading(self):
    """在资金来源子图上显示加载状态"""
    # 显示"加载中..."提示

def _show_cost_loading(self):
    """在成本涨幅子图上显示加载状态"""
    # 显示"加载中..."提示
```

### 异步任务启动
```python
def _start_async_loading(self, data: pd.DataFrame, x_index: np.ndarray):
    """启动异步加载任务"""
    # 取消之前的异步任务
    # 显示加载状态
    # 启动资金来源异步任务
    # 启动成本涨幅信号异步任务
```

## 使用方法

### 1. 正常使用
用户无需做任何特殊操作，异步加载会自动进行：
1. 选择股票后，主图表立即显示
2. 资金来源图和成本涨幅图显示"加载中..."
3. 后台异步加载数据
4. 数据加载完成后自动更新图表

### 2. 切换股票
当用户切换股票时：
1. 自动取消之前的异步任务
2. 新股票的主图表立即显示
3. 新的异步加载任务开始

### 3. 刷新数据
当用户刷新数据时：
1. 自动取消之前的异步任务
2. 重新加载主图表
3. 重新启动异步加载任务

## 性能提升

### 主图表加载速度
- **原来**: 需要等待资金来源数据和信号点计算完成
- **现在**: 主图表立即显示，提升用户体验

### 响应性
- **原来**: 用户操作需要等待所有数据加载完成
- **现在**: 用户操作立即响应，数据在后台加载

### 资源利用
- **原来**: 主线程被阻塞，无法响应用户操作
- **现在**: 主线程保持响应，后台线程处理耗时操作

## 注意事项

### 1. 数据一致性
- 异步加载过程中，如果用户切换股票，旧数据会被丢弃
- 确保显示的数据始终与当前股票匹配

### 2. 内存管理
- 异步任务使用daemon线程，主程序退出时自动清理
- 任务取消时会等待线程完成（超时0.1秒）

### 3. 错误处理
- 异步任务出错时会在控制台输出错误信息
- 加载状态会自动隐藏，避免界面卡死

## 调试模式

可以通过设置全局变量开启调试模式：
```python
DEBUG_FUND_BROKER_DETAILS = True
```

调试模式下会输出详细的资金来源数据计算过程。

## 测试

运行测试文件验证功能：
```bash
python test_async_loading.py
```

测试包括：
- 显示股票
- 切换股票
- 刷新数据
- 切换周期
- 缩放操作

每个操作都会验证异步任务的取消和重新启动。

