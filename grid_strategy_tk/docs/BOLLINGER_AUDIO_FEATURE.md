# 布林带突破/跌破音效功能实现

## 功能概述

为分时窗口的5分钟K线破布林上下轨事件添加了统一的音效提醒功能，参考了现有买入卖出信号音效的实现方式。

## 实现细节

### 1. 音效模块扩展 (`audio_notifier.py`)

在 `AudioNotifier` 类中新增了两个音效方法：
- `play_bollinger_breakthrough()`: 播放布林带突破音效
- `play_bollinger_breakdown()`: 播放布林带跌破音效

同时添加了对应的全局函数：
- `notify_bollinger_breakthrough()`: 布林带突破通知
- `notify_bollinger_breakdown()`: 布林带跌破通知

### 2. 分时窗口音效集成 (`intraday_window.py`)

#### 新增属性
```python
# 布林带音效相关属性
self.bollinger_breakthrough_signals: List[Dict[str, Any]] = []  # 布林带突破信号列表
self.bollinger_breakdown_signals: List[Dict[str, Any]] = []     # 布林带跌破信号列表
self.bollinger_breakthrough_consecutive_count = 0  # 布林带突破连续次数
self.bollinger_breakdown_consecutive_count = 0     # 布林带跌破连续次数
self.last_bollinger_signal_type = None  # 上一个布林带信号类型
self._bollinger_signals_processed = False  # 标记布林带信号是否已处理
```

#### 核心方法

1. **`_calculate_breakthrough_breakdown_count()`**
   - 在检测到突破/跌破时，将信号信息添加到对应的信号列表中
   - 每次计算前清空信号列表，避免重复播放

2. **`_is_bollinger_signal_realtime()`**
   - 判断布林带信号是否为实时信号（2分钟内）

3. **`_update_bollinger_signal_counters()`**
   - 更新布林带信号连续计数器，实现连续播放控制

4. **`_should_play_bollinger_audio()`**
   - 判断是否应该播放布林带音效（连续3次后停止）

5. **`_play_signal_audio_notifications()`**
   - 集成布林带音效播放逻辑
   - 支持震动提醒和音效播放
   - 实现连续播放控制机制

## 功能特性

### 1. 实时检测与立刻播放
- 检测5分钟K线实体最高价突破布林上轨
- 检测5分钟K线实体最低价跌破布林下轨
- **信号检测到后立刻播放音效**（无需等待2分钟实时检测）

### 2. 连续播放控制
- 突破信号连续播放最多3次
- 跌破信号连续播放最多3次
- 超过限制后停止音效播放，避免噪音干扰

### 3. 音效与震动
- 与现有买入卖出信号音效保持一致
- 支持音效开关控制
- 同时触发窗口震动提醒

### 4. 信号管理
- 每次数据更新时清空信号列表
- 避免重复播放同一信号
- 支持信号类型识别和计数

### 5. 智能提示信息
- **突破信号**: 显示"破上轨: X次\n看涨，开口朝上追，否则等中轨"
- **跌破信号**: 显示"破下轨: X次\n看跌，开口朝下杀，否则等中轨"
- 提供具体的交易策略建议

## 使用方法

1. **启用音效**: 点击分时窗口工具栏的音效按钮（🔊/🔇）
2. **音效播放**: 当5分钟K线突破或跌破布林带时自动播放
3. **连续控制**: 连续信号超过3次后自动停止音效

## 技术实现

### 信号检测流程
1. 计算5分钟K线数据
2. 检测实体价格与布林带位置关系
3. **立刻播放音效**（在检测到信号时立即触发）
4. 将信号添加到信号列表（用于后续处理）
5. 更新图表显示文字和提示信息

### 音效播放流程
1. 检查是否有实时布林带信号
2. 更新连续计数器
3. 判断是否应该播放音效
4. 触发窗口震动
5. 在单独线程中播放音效

## 兼容性

- 与现有买入卖出信号音效系统完全兼容
- 支持音效开关统一控制
- 不影响现有功能正常运行

## 音效配置

系统现在使用5种不同的音效：
1. **买入信号**: Glass.aiff（玻璃声）
2. **卖出信号**: Sosumi.aiff（Sosumi音效）
3. **布林带突破**: Funk.aiff（Funk音效，节奏感强）
4. **布林带跌破**: Bottle.aiff（瓶子音效，清脆短促）
5. **一般警告**: Ping.aiff（Ping音效）

## 测试验证

已通过音效模块测试，确认：
- 布林带突破音效正常播放（Funk音效）
- 布林带跌破音效正常播放（Bottle音效）
- 音效控制机制正常工作
- 不同音效能清晰区分突破和跌破

## 问题修复

### 初始化音效误触发问题
- **问题**: 窗口刚加载时可能播放布林带突破跌破音效
- **原因**: 历史数据被误判为实时信号
- **解决方案**: 
  1. 添加初始化检查标志 `_initialization_complete`
  2. 在 `_calculate_breakthrough_breakdown_count` 方法中检查初始化状态
  3. 添加实时数据检查，确保只有最新数据才触发音效
  4. 在数据更新完成后设置初始化完成标志

### 音效播放优化
- **只播放1次**: 将连续播放限制从3次改为1次
- **实时检查**: 只有2分钟内的实时信号才播放音效
- **初始化保护**: 避免窗口加载时的误触发

### 震动和音效同步
- **同步触发**: 震动和音效在同一个线程中执行，确保完全同步
- **立即响应**: 检测到信号后立即启动震动和音效线程
- **主窗口震动**: 震动主K线图窗口，提供视觉反馈
- **线程安全**: 使用daemon线程，避免阻塞主程序

### 买入卖出信号同步修复
- **问题**: 买入卖出信号存在震动和音效不同步的问题（震动立即触发，音效延迟0.1秒）
- **解决方案**: 将所有信号（买入、卖出、布林带）的震动和音效统一在同一个线程中执行
- **统一处理**: 使用`play_all_signals_audio_and_shake`函数统一处理所有类型的信号
- **完全同步**: 消除了所有信号类型的震动和音效延迟问题

